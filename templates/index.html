<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Gemini Console</title>
    <style>
        :root {
            --bg-color: #111b21;
            --sidebar-color: #202c33;
            --chat-bg: #0b141a;
            --msg-in: #202c33;
            --msg-out: #005c4b;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --accent: #00a884;
            --danger: #ef5350;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-primary); height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar */
        #sidebar { width: 30%; max-width: 400px; background-color: var(--sidebar-color); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background-color: var(--sidebar-color); border-bottom: 1px solid #333; font-weight: bold; }
        #contact-list { overflow-y: auto; flex: 1; }
        .contact-item { padding: 15px; border-bottom: 1px solid #2a3942; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .contact-item:hover { background-color: #2a3942; }
        .contact-item.active { background-color: #2a3942; border-left: 4px solid var(--accent); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .status-active { background-color: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .status-paused { background-color: var(--danger); box-shadow: 0 0 5px var(--danger); }

        /* Main Chat */
        #main { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); position: relative; }
        #chat-header { padding: 15px; background-color: var(--sidebar-color); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #0b141a; }
        
        .message { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4; position: relative; }
        .msg-user { align-self: flex-start; background-color: var(--msg-in); color: white; border-top-left-radius: 0; }
        .msg-agent { align-self: flex-end; background-color: var(--msg-out); color: white; border-top-right-radius: 0; }
        .msg-manual { border: 2px solid var(--accent); } /* Highlight manual messages */
        .msg-time { font-size: 10px; color: rgba(255,255,255,0.6); text-align: right; margin-top: 4px; }

        /* Footer Input */
        #chat-footer { padding: 15px; background-color: var(--sidebar-color); display: flex; gap: 10px; align-items: center; }
        textarea { flex: 1; background-color: #2a3942; border: none; border-radius: 8px; color: white; padding: 10px; resize: none; outline: none; height: 50px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-send-stop { background-color: var(--danger); }
        .btn-restore { background-color: var(--accent); }
        .btn:disabled { background-color: gray; cursor: not-allowed; }

        #empty-state { flex: 1; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); font-size: 1.2rem; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">Contactos</div>
    <div id="contact-list">
        </div>
</div>

<div id="main">
    <div id="chat-header" style="display:none;">
        <div>
            <span id="current-phone-display" style="font-size: 1.1rem; font-weight: bold;"></span>
            <br>
            <span id="agent-status-display" style="font-size: 0.8rem; color: var(--text-secondary);"></span>
        </div>
        <button id="btn-restore-header" class="btn btn-restore" onclick="restoreAgent()">Restaurar Agente</button>
    </div>

    <div id="chat-messages">
        </div>
    <div id="empty-state">Selecciona un chat para comenzar</div>

    <div id="chat-footer" style="display:none;">
        <textarea id="msg-input" placeholder="Escribe tu respuesta manual..."></textarea>
        <button class="btn btn-send-stop" onclick="sendAndStop()">Enviar / Frenar</button>
    </div>
</div>

<script>
    let currentPhone = null;
    let refreshInterval = null;

    // Cargar contactos al inicio
    fetchContacts();
    setInterval(fetchContacts, 5000); // Refrescar lista de contactos cada 5 seg

    async function fetchContacts() {
        try {
            const res = await fetch('/api/contacts');
            const contacts = await res.json();
            renderContacts(contacts);
        } catch (e) { console.error(e); }
    }

    function renderContacts(contacts) {
        const list = document.getElementById('contact-list');
        // Guardamos la selecci贸n actual para no perderla visualmente
        const currentSelection = currentPhone; 
        
        list.innerHTML = '';
        contacts.forEach(c => {
            const div = document.createElement('div');
            div.className = `contact-item ${c.phone === currentSelection ? 'active' : ''}`;
            div.onclick = () => selectContact(c.phone, c.status);
            
            const statusClass = c.status === 'ACTIVE' ? 'status-active' : 'status-paused';
            
            div.innerHTML = `
                <span>${c.phone}</span>
                <span class="status-dot ${statusClass}" title="${c.status}"></span>
            `;
            list.appendChild(div);
        });
    }

    function selectContact(phone, status) {
        currentPhone = phone;
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('chat-messages').style.display = 'flex';
        document.getElementById('chat-footer').style.display = 'flex';
        
        document.getElementById('current-phone-display').innerText = phone;
        updateHeaderStatus(status);

        // Limpiar intervalo anterior si existe
        if (refreshInterval) clearInterval(refreshInterval);
        
        loadHistory();
        // Polling cada 2 segundos para ver mensajes nuevos
        refreshInterval = setInterval(loadHistory, 2000);
    }

    function updateHeaderStatus(status) {
        const display = document.getElementById('agent-status-display');
        const btnRestore = document.getElementById('btn-restore-header');
        
        if (status === 'ACTIVE') {
            display.innerText = ' Agente Activo';
            display.style.color = 'var(--accent)';
            btnRestore.style.display = 'none';
        } else {
            display.innerText = '革 Agente Pausado (Modo Manual)';
            display.style.color = 'var(--danger)';
            btnRestore.style.display = 'block';
        }
    }

    async function loadHistory() {
        if (!currentPhone) return;
        try {
            const res = await fetch(`/api/history/${currentPhone}`);
            const history = await res.json();
            renderHistory(history);
        } catch (e) { console.error(e); }
    }

    function renderHistory(history) {
        const chat = document.getElementById('chat-messages');
        // Opci贸n: Detectar si el usuario est谩 haciendo scroll arriba para no moverlo
        const shouldScroll = chat.scrollTop + chat.clientHeight === chat.scrollHeight;

        chat.innerHTML = '';
        history.forEach(msg => {
            const div = document.createElement('div');
            const isAgent = msg.sender === 'agent';
            const isManual = msg.text.startsWith('[MANUAL]');
            
            div.className = `message ${isAgent ? 'msg-agent' : 'msg-user'} ${isManual ? 'msg-manual' : ''}`;
            
            // Limpiamos el texto [MANUAL] para visualizaci贸n si se quiere, o lo dejamos
            const textDisplay = msg.text.replace('nan', ''); 
            if(!textDisplay) return;

            div.innerHTML = `
                ${textDisplay}
                <div class="msg-time">${msg.time}</div>
            `;
            chat.appendChild(div);
        });

        // Scroll al fondo solo si estaba abajo o es la primera carga
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendAndStop() {
        const txt = document.getElementById('msg-input');
        const message = txt.value.trim();
        if (!message) return;

        txt.value = ''; // Limpiar input
        
        try {
            const res = await fetch('/api/send_manual', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: currentPhone, message: message })
            });
            const data = await res.json();
            if(data.status === 'success') {
                updateHeaderStatus('PAUSED');
                loadHistory(); // Recargar chat inmediatamente
                fetchContacts(); // Actualizar puntito rojo en sidebar
            } else {
                alert('Error al enviar: ' + data.message);
            }
        } catch (e) { alert('Error de red'); }
    }

    async function restoreAgent() {
        if(!confirm("驴Seguro que deseas reactivar la IA para este usuario?")) return;
        
        try {
            const res = await fetch('/api/restore_agent', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: currentPhone })
            });
            const data = await res.json();
            if(data.status === 'success' || data.status === 'no_change') {
                updateHeaderStatus('ACTIVE');
                fetchContacts();
            }
        } catch (e) { alert('Error de red'); }
    }
</script>

</body>
</html>