<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Gemini Console</title>
    <style>
        :root {
            --bg-color: #111b21;
            --sidebar-color: #202c33;
            --chat-bg: #0b141a;
            --msg-in: #202c33;
            --msg-out: #005c4b;
            --msg-manual: #8f1e1e; /* Rojo oscuro para mensajes manuales */
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --accent: #00a884;
            --danger: #ef5350;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-primary); height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar */
        #sidebar { width: 30%; max-width: 400px; background-color: var(--sidebar-color); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background-color: var(--sidebar-color); border-bottom: 1px solid #333; font-weight: bold; }
        #contact-list { overflow-y: auto; flex: 1; }
        .contact-item { padding: 15px; border-bottom: 1px solid #2a3942; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .contact-item:hover { background-color: #2a3942; }
        .contact-item.active { background-color: #2a3942; border-left: 4px solid var(--accent); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .status-active { background-color: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .status-paused { background-color: var(--danger); box-shadow: 0 0 5px var(--danger); }

        /* Main Chat */
        #main { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); position: relative; }
        #chat-header { padding: 15px; background-color: var(--sidebar-color); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #0b141a; }
        
        .message { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4; position: relative; }
        
        .msg-user { align-self: flex-start; background-color: var(--msg-in); color: white; border-top-left-radius: 0; }
        .msg-agent { align-self: flex-end; background-color: var(--msg-out); color: white; border-top-right-radius: 0; }
        
        /* ESTILO ROJO PARA MENSAJES MANUALES DEL HUMANO */
        .msg-manual-human { align-self: flex-end; background-color: var(--msg-manual); color: white; border-top-right-radius: 0; border: 1px solid #ff6b6b; }
        
        .msg-time { font-size: 10px; color: rgba(255,255,255,0.6); text-align: right; margin-top: 4px; }

        /* Footer Input */
        #chat-footer { padding: 15px; background-color: var(--sidebar-color); display: flex; gap: 10px; align-items: center; }
        textarea { flex: 1; background-color: #2a3942; border: none; border-radius: 8px; color: white; padding: 10px; resize: none; outline: none; height: 50px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-send-stop { background-color: var(--danger); }
        .btn-restore { background-color: var(--accent); }

        #empty-state { flex: 1; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); font-size: 1.2rem; }
        
        /* Alertas */
        .alert-error { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background-color: rgba(239, 83, 80, 0.9); padding: 10px 20px; border-radius: 20px; color: white; font-weight: bold; z-index: 100; animation: fadeOut 3s forwards; animation-delay: 2s; }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">Contactos</div>
    <div id="contact-list"></div>
</div>

<div id="main">
    <div id="alert-container"></div> <div id="chat-header" style="display:none;">
        <div>
            <span id="current-phone-display" style="font-size: 1.1rem; font-weight: bold;"></span>
            <br>
            <span id="agent-status-display" style="font-size: 0.8rem; color: var(--text-secondary);"></span>
        </div>
        <button id="btn-restore-header" class="btn btn-restore" onclick="restoreAgent()">Restaurar Agente</button>
    </div>

    <div id="chat-messages"></div>
    <div id="empty-state">Selecciona un chat para comenzar</div>

    <div id="chat-footer" style="display:none;">
        <textarea id="msg-input" placeholder="Escribe tu respuesta manual..."></textarea>
        <button class="btn btn-send-stop" onclick="sendAndStop()">Enviar / Frenar</button>
    </div>
</div>

<script>
    let currentPhone = null;
    let refreshInterval = null;

    fetchContacts();
    setInterval(fetchContacts, 3000); 

    async function fetchContacts() {
        try {
            const res = await fetch('/api/contacts');
            const contacts = await res.json();
            renderContacts(contacts);
        } catch (e) { console.error(e); }
    }

    function renderContacts(contacts) {
        const list = document.getElementById('contact-list');
        const currentSelection = currentPhone; 
        
        list.innerHTML = '';
        contacts.forEach(c => {
            const div = document.createElement('div');
            div.className = `contact-item ${c.phone === currentSelection ? 'active' : ''}`;
            div.onclick = () => selectContact(c.phone, c.status);
            
            const statusClass = c.status === 'ACTIVE' ? 'status-active' : 'status-paused';
            
            div.innerHTML = `
                <span>${c.phone}</span>
                <span class="status-dot ${statusClass}" title="${c.status}"></span>
            `;
            list.appendChild(div);
        });
    }

    function selectContact(phone, status) {
        currentPhone = phone;
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('chat-messages').style.display = 'flex';
        document.getElementById('chat-footer').style.display = 'flex';
        
        document.getElementById('current-phone-display').innerText = phone;
        updateHeaderStatus(status);

        if (refreshInterval) clearInterval(refreshInterval);
        
        loadHistory();
        refreshInterval = setInterval(loadHistory, 1000); // Polling m谩s r谩pido (1s) para sensaci贸n real-time
    }

    function updateHeaderStatus(status) {
        const display = document.getElementById('agent-status-display');
        const btnRestore = document.getElementById('btn-restore-header');
        
        if (status === 'ACTIVE') {
            display.innerText = ' Agente Activo';
            display.style.color = 'var(--accent)';
            btnRestore.style.display = 'none';
        } else {
            display.innerText = '革 Agente Pausado (Modo Manual)';
            display.style.color = 'var(--danger)';
            btnRestore.style.display = 'block';
        }
    }

    async function loadHistory() {
        if (!currentPhone) return;
        try {
            const res = await fetch(`/api/history/${currentPhone}`);
            const history = await res.json();
            renderHistory(history);
        } catch (e) { console.error(e); }
    }

    function renderHistory(history) {
        const chat = document.getElementById('chat-messages');
        const shouldScroll = chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 50;

        // Estrategia simple: Reemplazar todo. 
        // Para producci贸n masiva se recomienda usar keys y actualizar solo diferencias, pero aqu铆 va bien.
        chat.innerHTML = '';
        
        history.forEach(msg => {
            const div = document.createElement('div');
            let textContent = msg.text;
            let messageClass = '';

            if (msg.sender === 'user') {
                messageClass = 'msg-user';
            } else {
                // Es agente
                if (textContent.includes('[MANUAL]')) {
                    messageClass = 'msg-manual-human'; // Clase ROJA
                    textContent = textContent.replace('[MANUAL]', '').trim(); // Quitar etiqueta
                } else {
                    messageClass = 'msg-agent'; // Clase VERDE
                }
            }
            
            // Validar que no sea NaN o vacio visual
            if(!textContent || textContent === 'nan') return;

            div.className = `message ${messageClass}`;
            div.innerHTML = `
                ${textContent}
                <div class="msg-time">${msg.time.split(' ')[1] || ''}</div>
            `;
            chat.appendChild(div);
        });

        if (shouldScroll) chat.scrollTop = chat.scrollHeight;
    }

    async function sendAndStop() {
        const txt = document.getElementById('msg-input');
        const message = txt.value.trim();
        if (!message) return;

        txt.value = ''; 
        
        try {
            const res = await fetch('/api/send_manual', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: currentPhone, message: message })
            });
            const data = await res.json();
            if(data.status === 'success') {
                updateHeaderStatus('PAUSED');
                loadHistory(); 
                fetchContacts();
            } else {
                showError('Error al enviar: ' + data.message);
            }
        } catch (e) { showError('Error de red'); }
    }

    async function restoreAgent() {
        if(!confirm("驴Deseas reactivar la IA?")) return;
        
        try {
            const res = await fetch('/api/restore_agent', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: currentPhone })
            });
            
            // Manejo de c贸digos de estado HTTP
            if (res.status === 400) {
                 const data = await res.json();
                 showError(data.message); // Mostrar "debe dar una respuesta previa"
                 return;
            }

            const data = await res.json();
            if(data.status === 'success' || data.status === 'no_change') {
                updateHeaderStatus('ACTIVE');
                fetchContacts();
            }
        } catch (e) { showError('Error de red al restaurar'); }
    }

    function showError(msg) {
        const container = document.getElementById('alert-container');
        container.innerHTML = `<div class="alert-error">${msg}</div>`;
        // El CSS animation se encarga de desaparecerlo
        setTimeout(() => { container.innerHTML = ''; }, 6000);
    }
</script>

</body>
</html>